(function(t,e){t.widget("nlfeatures.nlfeatures",{options:{markup:{toolbar_class:"olControlEditingToolbar",id_prefix:"nlf-"},animation:{fade_duration:500},styles:{default_opacity:.4,default_color:"#ffb80e",select_point_radius:10,select_stroke_color:"#ea3a3a",point_graphic:{normal:e,selected:e}},map:{boundingBox:"90,0,-90,360",center:e,zoom:e,epsg:e,wmsAddress:e,raw_update:e},mode:null,json:null,zoom:null,center:null},_create:function(){this._instantiateOpenLayers(),this._currentVectorLayers=[],this._currentEditItem=null,this._currentEditLayer=null,this.clickedFeature=null,this.idToLayer={},this.requestData=null,this.options.json!==e&&null!==this.options.json?(this.loadLocalData([this.options.json]),this.setViewport(),"edit"===this.options.mode&&this.editJson(this.options.json,!0)):this.loadData()},_instantiateOpenLayers:function(){OpenLayers.IMAGE_RELOAD_ATTEMTPS=3,OpenLayers.Util.onImageLoadErrorColor="transparent",OpenLayers.ImgPath="http://js.mapbox.com/theme/dark/";var t,i,n=!0;OpenLayers.IMAGE_RELOAD_ATTEMPTS=5,OpenLayers.DOTS_PER_INCH=25.4/.28,format=n?"image/png8":"image/png",this.options.map.boundingBox===e?t=new OpenLayers.Bounds:(i=this.options.map.boundingBox.split(","),t=new OpenLayers.Bounds(parseFloat(i[0]),parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3])));var s=this.options.map.epsg!==e?this.options.map.epsg[0]:"EPSG:4326",r=[new OpenLayers.Control.Attribution,new OpenLayers.Control.Navigation,new OpenLayers.Control.PanZoomBar];"edit"===this.options.mode&&(r=r.concat([new OpenLayers.Control.MousePosition,new OpenLayers.Control.LayerSwitcher]));var o={controls:r,maxExtent:t,maxResolution:"auto",projection:s,units:"m"};if(this.map=new OpenLayers.Map(this.element.attr("id"),o),this.options.map.wmsAddress!==e?this.baseLayer=new OpenLayers.Layer.WMS(this.options.name,this.options.map.wmsAddress,{LAYERS:this.options.map.layers,STYLES:"",format:"image/jpeg",tiled:!n,tilesOrigin:this.map.maxExtent.left+","+this.map.maxExtent.bottom},{buffer:0,displayOutsideMaxExtent:!0,isBaseLayer:!0}):(this.baseLayers=this._getBaseLayers(),this.baseLayer=this.baseLayers[this.options.base_layer]!==e?this.baseLayers[this.options.base_layer]:this.baseLayers.osm),this.map.addLayers([this.baseLayers.osm,this.baseLayers.gphy,this.baseLayers.gmap,this.baseLayers.ghyb,this.baseLayers.gsat]),this.baseLayers.swc!==e&&this.map.addLayers([this.baseLayers.stn,this.baseLayers.str,this.baseLayers.swc]),this.map.setBaseLayer(this.baseLayer),this.exists(this.options.default_map_bounds)&&(i=this.options.default_map_bounds.split(","),t=new OpenLayers.Bounds(parseFloat(i[0]),parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3]))),this.options.map.center!==e){var a=this.options.map.zoom===e?3:this.options.map.zoom,l=new OpenLayers.LonLat(this.options.map.center[0],this.options.map.center[1]);this.map.setCenter(l,a)}else this.map.zoomToExtent(t)},_getBaseLayers:function(){var t={};if(t.gphy=new OpenLayers.Layer.Google("Google Physical",{type:google.maps.MapTypeId.TERRAIN}),t.gmap=new OpenLayers.Layer.Google("Google Streets",{numZoomLevels:20}),t.ghyb=new OpenLayers.Layer.Google("Google Hybrid",{type:google.maps.MapTypeId.HYBRID,numZoomLevels:20}),t.gsat=new OpenLayers.Layer.Google("Google Satellite",{type:google.maps.MapTypeId.SATELLITE,numZoomLevels:22}),t.osm=new OpenLayers.Layer.OSM,OpenLayers.Layer.Stamen!==e){var i='Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>.';t.swc=new OpenLayers.Layer.Stamen("Stamen Watercolor",{provider:"watercolor",attribution:i,tileOptions:{crossOriginKeyword:null}}),t.stn=new OpenLayers.Layer.Stamen("Stamen Toner",{provider:"toner",attribution:i,tileOptions:{crossOriginKeyword:null}}),t.str=new OpenLayers.Layer.Stamen("Stamen Terrain",{provider:"terrain",attribution:i,tileOptions:{crossOriginKeyword:null}})}return t},loadData:function(){var i=this;this._resetData(),this.exists(this.requestData)&&this.requestData.abort(),this.options.dataSources!==e&&this.options.dataSources.maps!==e&&(this.requestData=t.ajax({url:this.options.dataSources.map,dataType:"json",success:function(t){i._buildVectorLayers(t),i._addClickControls(),i.exists(i._currentEditItem)&&i.editJson(i._currentEditItem,!0)}}))},loadLocalData:function(t){this._resetData(),this._buildVectorLayers(t),"edit"===this.options.mode&&this._addClickControls()},_resetData:function(){var e=this;this._removeControls(),t.each(this._currentVectorLayers,function(t,i){e.map.removeLayer(i),i.destroy()}),this._currentVectorLayers=[],this.idToLayer={}},_buildVectorLayers:function(i){var n=this,s=!1;this.idToLayer={},this.layerToId={},t.each(i,function(i,r){var o=r.id,a=""!==r.color?r.color:n.options.styles.default_color,l=n._getStyleMap(a),u=new OpenLayers.Layer.Vector(r.title,{styleMap:l});if(null!==r.geo&&r.geo!==e){var d=new OpenLayers.Format.KML,h=d.read(r.geo);if(0===h.length){var p=new OpenLayers.Format.WKT;t.each(r.geo.split("|"),function(t,i){if(p.read(i)!==e){var n=new OpenLayers.Geometry.fromWKT(i),s=new OpenLayers.Feature.Vector(n);h.push(s)}}),s=h.length>0}h.length>0&&u.addFeatures(h)}u.setMap(n.map),n.idToLayer[o]=u,n.layerToId[u.id]=o,n._currentVectorLayers.push(u),n.map.addLayer(u)}),s&&setTimeout(function(){n.element.trigger("refresh.nlfeatures")},250)},selectFeature:function(t){this.isFocusLocked()||(this.modifyFeatures.selectFeature(t),this.clickControl.highlight(t),this.listenToFeature(t),this.clickedFeature=t,this.element.trigger("select.nlfeatures",t))},getFeatureElement:function(e){var i;return i=("#"+e.geometry.id).replace(/\./g,"\\."),t(i)},listenToFeature:function(t){var e,i,n;e=t.id,i=this,n=this.getFeatureElement(t),n.on({mousedown:function(){i.lockFocus(t)},mouseup:function(){i.unlockFocus(t)}})},unlistenToFeature:function(t,i){var n;n=this,(null===i||i===e)&&(i=this.getFeatureElement(t)),i.off("mouseup").off("mousedown")},deselectFeature:function(t,i){(null===t||t===e)&&(t=this.clickedFeature),(!this.isFocusLocked(t)||i)&&(this.clickControl.unhighlight(t),this.modifyFeatures.unselectFeature(t),this.unlistenToFeature(t),this.resetModifyFeatures(),t.nlfeatures&&(t.nlfeatures.focusLocked=!1),t===this.clickedFeature&&(this.clickedFeature=null),this.element.trigger("deselect.nlfeatures",t))},lockFocus:function(t){(null===t||t===e)&&(t=this.clickedFeature),null!==t&&t!==e&&(null===t.nlfeatures||t.nlfeatures===e?t.nlfeatures={focusLocked:!0}:t.nlfeatures.focusLocked=!0)},unlockFocus:function(t){(null===t||t===e)&&(t=this.clickedFeature),null!==t&&t!==e&&null!==t.nlfeatures&&t.nlfeatures!==e&&(t.nlfeatures.focusLocked=!1)},isFocusLocked:function(t){return(null===t||t===e)&&(t=this.clickedFeature),null!==t&&t!==e&&null!==t.nlfeatures&&t.nlfeatures!==e&&t.nlfeatures.focusLocked},_addClickControls:function(){var t=this;this._removeControls(),this.clickControl=new OpenLayers.Control.SelectFeature(this._currentVectorLayers,{hover:!0,highlightOnly:!0,overFeature:function(i){null===i.geometry.parent&&i.geometry.parent===e&&(t.modifyFeatures!==e&&null!==t.clickedFeature&&t.clickedFeature!==e&&i.id!==t.clickedFeature.id&&t.deselectFeature(),t.modifyFeatures===e||null!==t.clickedFeature&&t.clickedFeature!==e&&i.id===t.clickedFeature.id||t.selectFeature(i))},outFeature:function(){return!1}}),this.map.addControl(this.clickControl),this.clickControl.activate(),this.map.events.register("click",this.map,function(){null!==t.clickedFeature&&t.clickedFeature!==e&&t.deselectFeature(t.clickedFeature,!0)})},_removeControls:function(){this.modifyFeatures!==e&&(this.map.removeControl(this.modifyFeatures),this.modifyFeatures.destroy(),delete this.modifyFeatures),this.editToolbar!==e&&(this.map.removeControl(this.editToolbar),this.editToolbar.destroy(),delete this.editToolbar),this.clickControl!==e&&(this.map.removeControl(this.clickControl),this.clickControl.destroy(),delete this.clickControl),this.highlightControl!==e&&(this.map.removeControl(this.highlightControl),this.highlightControl.destroy(),delete this.highlightControl)},edit:function(t,e){var i={id:t.attr("recordid"),name:t.find("span.item-title-text").text()};this.editJson(i,e)},editJson:function(i,n){var s=this;this.highlightControl!==e&&this.highlightControl.deactivate();var r=i.id;if(this._currentEditLayer=this.idToLayer[r],this._currentEditId=r,this._currentEditItem=i,!this._currentEditLayer){var o=i.name;this._currentEditLayer=new OpenLayers.Layer.Vector(o),this.map.addLayer(this._currentEditLayer),this._currentEditLayer.setMap(this.map),this._currentVectorLayers.push(this._currentEditLayer),this.idToLayer[r]=this._currentEditLayer,this.layerToId[this._currentEditLayer.id]=r}var a=[new OpenLayers.Control.Navigation,new OpenLayers.Control.DrawFeature(this._currentEditLayer,OpenLayers.Handler.Path,{displayClass:"olControlDrawFeaturePath",featureAdded:function(){s.element.trigger("featureadded.nlfeatures")}}),new OpenLayers.Control.DrawFeature(this._currentEditLayer,OpenLayers.Handler.Point,{displayClass:"olControlDrawFeaturePoint",featureAdded:function(){s.element.trigger("featureadded.nlfeatures")}}),new OpenLayers.Control.DrawFeature(this._currentEditLayer,OpenLayers.Handler.Polygon,{displayClass:"olControlDrawFeaturePolygon",featureAdded:function(){s.element.trigger("featureadded.nlfeatures")}})];this.modifyFeatures=new OpenLayers.Control.ModifyFeature(this._currentEditLayer,{onModification:function(){s.element.trigger("featureadded.nlfeatures")},standalone:!0}),this.editToolbar=new OpenLayers.Control.Panel({defaultControl:a[0],displayClass:this.options.markup.toolbar_class}),this.editToolbar.addControls(a),this.map.addControl(this.editToolbar),this.map.addControl(this.modifyFeatures),this.modifyFeatures.activate(),this.element.editfeatures({markup:{id_prefix:this.options.markup.id_prefix}}),this.element.bind({"update.nlfeatures":function(t,e){s.modifyFeatures.mode=OpenLayers.Control.ModifyFeature.RESHAPE,e.rotate&&(s.modifyFeatures.mode|=OpenLayers.Control.ModifyFeature.ROTATE),e.scale&&(s.modifyFeatures.mode|=OpenLayers.Control.ModifyFeature.RESIZE),e.drag&&(s.modifyFeatures.mode|=OpenLayers.Control.ModifyFeature.DRAG),(e.drag||e.rotate)&&(s.modifyFeatures.mode&=-OpenLayers.Control.ModifyFeature.RESHAPE);var i=s.modifyFeatures.feature;s.exists(i)&&(s.modifyFeatures.unselectFeature(i),s.modifyFeatures.selectFeature(i))},"lockfocus.nlfeatures":function(){s.lockFocus()},"unlockfocus.nlfeatures":function(){s.unlockFocus()},"delete.nlfeatures":function(){if(s.modifyFeatures.feature){var t=s.modifyFeatures.feature;s.clickedFeature=null,s.modifyFeatures.unselectFeature(t),s._currentEditLayer.destroyFeatures([t])}}}),n?t("."+this.options.markup.toolbar_class).css("opacity",1):(this.element.editfeatures("showButtons",n),t("."+this.options.markup.toolbar_class).animate({opacity:1},this.options.animation.fade_duration)),this.options.map.raw_update!==e&&(this.options.map.raw_update,this.element.bind({"featureadded.nlfeatures":function(){s.updateRaw()},"update.nlfeatures":function(){s.updateRaw()},"delete.nlfeatures":function(){s.updateRaw()}}));var l=!1;t.each(this._currentEditLayer.features,function(t,e){e==s.clickedFeature&&(l=!0)}),l&&this.modifyFeatures.selectFeature(this.clickedFeature)},resetModifyFeatures:function(){this.modifyFeatures.mode=OpenLayers.Control.ModifyFeature.RESHAPE},editJsonItem:function(t){this.loadLocalData([t]),this.setViewport(),this.editJson(t,!0)},setViewport:function(){this.viewportOptionsValid()?this._setViewportFromOptions():this._setViewportFromData()},viewportOptionsValid:function(){var t=!0;return t=t&&null!==this.options.zoom&&this.options.zoom,t=t&&this.options.zoom>0,t=t&&null!==this.options.center&&this.options.center!==e,t=t&&null!==this.options.center.lon&&this.options.center.lon!==e,t=t&&null!==this.options.center.lat&&this.options.center.lat!==e,t=t&&!isNaN(parseFloat(this.options.center.lon)),t=t&&!isNaN(parseFloat(this.options.center.lat))},_setViewportFromOptions:function(){var t,i,n=this.options.zoom,s=this.options.center,r=new OpenLayers.LonLat(s.lon,s.lat);null!==s.srs&&s.srs!==e&&(i=new OpenLayers.Projection(s.srs),t=this.map.getProjectionObject(),r=r.transform(i,t)),this.map.setCenter(r,n,!1,!1)},_setViewportFromData:function(){var t,e,i,n,s,r,o,a,l,u;for(t=this,l=new OpenLayers.Bounds,e=0,n=this._currentVectorLayers.length,i=0;n>i;i++)for(s=this._currentVectorLayers[i],o=s.features.length,r=0;o>r;r++)e++,a=s.features[r].geometry,l.extend(a.getBounds());0===e?(u=new OpenLayers.Control.Geolocate({bind:!0,watch:!1}),u.events.on({locationfailed:function(){t.map.setCenter(new OpenLayers.LonLat(-8738850.21367,4584105.47978),3,!1,!1)}}),this.map.addControl(u),this.map.zoomTo(3),u.activate()):this.map.zoomToExtent(l,!1)},updateRaw:function(){var t=this.options.map.raw_update;if(this.exists(t)){var e=this.getWktForSave();e=e.replace(/\|/g,"|\n"),t.val(e)}},endEditWithoutSave:function(e,i){var n=t("."+this.options.markup.toolbar_class).clone();this.modifyFeatures.unselectFeature(this.clickedFeature),this.map.removeControl(this.modifyFeatures),this.map.removeControl(this.editToolbar),i||(this.element.editfeatures("hideButtons"),this.element.append(n),n.animate({opacity:0},this.options.animation.fade_duration,function(){n.remove()})),this._addClickControls(),0===this._currentEditLayer.features.length&&(this.map.removeLayer(this._currentEditLayer),this._currentVectorLayers.remove(this._currentEditLayer),delete this.idToLayer[e],delete this.layerToId[this._currentEditLayer.id],this._currentEditLayer=null),this._currentEditItem=null},getBaseLayerCode:function(){var t,e,i,n,s,r;for(r=this.map.baseLayer.name,i=null,n=["osm","gphy","gmap","ghyb","gsat","swc","stn","str"],s=0,e=n.length;e>s;s++)if(t=n[s],r===this.baseLayers[t].name){i=t;break}return i},getWktForSave:function(){var t=[];return this._getFeatures(function(e,i){t.push(""+i.geometry)}),t.join("|")},getKml:function(){var t=new OpenLayers.Format.KML,e=[];return this._getFeatures(function(t,i){e.push(i)}),t.write(e)},_getFeatures:function(e){var i=this.exists(this.clickedFeature);i&&this.modifyFeatures.unselectFeature(this.clickedFeature),t.each(this._currentEditLayer.features,e),i&&this.modifyFeatures.selectFeature(this.clickedFeature)},getExtentForSave:function(){return""+this.map.getExtent()},getZoomForSave:function(){return this.map.getZoom()},zoomToItemVectors:function(t){var e=this.idToLayer[t];this.exists(e)&&e.features.length>0&&this.map.zoomToExtent(e.getDataExtent())},_getStyleMap:function(t){return new OpenLayers.StyleMap({"default":new OpenLayers.Style({fillColor:t,fillOpacity:this.options.styles.default_opacity,strokeColor:t,strokeWidth:1,pointRadius:10}),select:new OpenLayers.Style({fillColor:t,fillOpacity:this.options.styles.default_opacity,strokeColor:this.options.styles.select_stroke_color,strokeWidth:2,pointRadius:10})})},setItemColor:function(t){this._currentEditLayer.styleMap=this._getStyleMap(t),this._currentEditLayer.redraw()},getCenterLonLat:function(){var t=new OpenLayers.Projection("EPSG:4326"),e=this.map.getProjectionObject();return this.map.getCenter().transform(e,t)},setCenterLonLat:function(t,e){var i=new OpenLayers.LonLat(t,e),n=new OpenLayers.Projection("EPSG:4326"),s=this.map.getProjectionObject();return this.map.panTo(i.transform(n,s))},setZoom:function(t){return this.map.zoomTo(t)},hasPoint:function(){return this.hasFeature("OpenLayers.Geometry.Point")},hasLine:function(){return this.hasFeature("OpenLayers.Geometry.LineString")},hasPolygon:function(){return this.hasFeature("OpenLayers.Geometry.Polygon")},hasFeature:function(e){return result=!1,t.each(this._currentVectorLayers,function(i,n){t.each(n.features,function(t,i){result=result||i.geometry.CLASS_NAME==e})}),result},exists:function(t){return t!==e&&null!==t},getSavedZoom:function(){return this.options.zoom},getSavedCenter:function(){return this.options.center},saveViewport:function(){var t=this.map.getCenter(),e=this.map.getZoom();this.options.zoom=e,this.options.center={lon:t.lon,lat:t.lat}}})})(jQuery),function(t){t.widget("nlfeatures.editfeatures",{options:{markup:{geo_edit_class:"geo-edit",id_prefix:"nlf-"},animation:{fade_duration:500}},_createEditButton:function(e,i,n){var s=i.split(" ",1)[0];return t('<button id="'+e+s+'" '+'type="button" class="btn edit-geometry-small geo-edit '+i+'">'+n+"</button>")},_create:function(){var t=this,e=this.options.markup.id_prefix;"#"==e.charAt(0)&&(e=e.substr(1)),this.scaleButton=this._createEditButton(e,"scale-button radio-button sel-button","Scale"),this.rotateButton=this._createEditButton(e,"rotate-button radio-button sel-button","Rotate"),this.dragButton=this._createEditButton(e,"drag-button radio-button sel-button","Drag"),this.deleteButton=this._createEditButton(e,"delete-button sel-button","Delete"),this.viewportButton=this._createEditButton(e,"viewport-button","Save View"),this.element.append(this.dragButton),this.element.append(this.rotateButton),this.element.append(this.scaleButton),this.element.append(this.deleteButton),this.element.append(this.viewportButton),this.radioButtons=this.element.children("button.radio-button"),this.selectionButtons=this.element.children("button.sel-button"),this.radioButtons.data("activated",!1),this.disableAll(),this.element.bind({"select.nlfeatures":function(){t.enableAll()},"deselect.nlfeatures":function(){t.disableAll()}}),this.dragButton.bind({mousedown:function(){t.toggleButton(t.dragButton),t.triggerUpdateEvent()},click:function(t){t.preventDefault()}}),this.scaleButton.bind({mousedown:function(){t.toggleButton(t.scaleButton),t.triggerUpdateEvent()},click:function(t){t.preventDefault()}}),this.rotateButton.bind({mousedown:function(){t.toggleButton(t.rotateButton),t.triggerUpdateEvent()},click:function(t){t.preventDefault()}}),this.deleteButton.bind({mousedown:function(){t.element.trigger("delete.nlfeatures")},click:function(t){t.preventDefault()}}),this.viewportButton.bind({mousedown:function(){t.element.trigger("saveview.nlfeatures")},click:function(t){t.preventDefault()}})},showButtons:function(){this.element.children("button").css({display:"block !important",opacity:0}).stop().animate({opacity:1},this.options.animation.fade_duration),this.deactivateAllButtons()},hideButtons:function(){var t=this.element.children("button");t.stop().animate({opacity:0},this.options.markup.fade_duration,function(){t.css("display","none !important")})},deactivateAllButtons:function(){this.radioButtons.removeClass("primary").data("activated",!1)},disableAll:function(){this.selectionButtons.removeClass("primary").addClass("disabled"),this.selectionButtons.each(function(){this.disabled=!0})},enableAll:function(){this.selectionButtons.removeClass("disabled"),this.selectionButtons.each(function(){this.disabled=!1})},activateButton:function(t){this.deactivateAllButtons(),t.addClass("primary").data("activated",!0),this.element.trigger("lockfocus.nlfeatures")},deactivateButton:function(t){t.removeClass("primary").data("activated",!1),this.element.trigger("unlockfocus.nlfeatures")},toggleButton:function(t){t.data("activated")?this.deactivateButton(t):this.activateButton(t)},triggerUpdateEvent:function(){this.element.trigger("update.nlfeatures",[{drag:this.dragButton.data("activated"),rotate:this.rotateButton.data("activated"),scale:this.scaleButton.data("activated")}])}})}(jQuery),function(){var t={}.hasOwnProperty,e=function(e,i){function n(){this.constructor=e}for(var s in i)t.call(i,s)&&(e[s]=i[s]);return n.prototype=i.prototype,e.prototype=new n,e.__super__=i.prototype,e};(function(t){var i,n,s,r,o,a,l,u;return o=function(t){return"#"===t[0]?t.slice(1,t.length):t},u=function(t){return null!=t?""+t:""},a=function(t,e,i,n){var s,r,o;return null==i&&(i=null),null==n&&(n=100),s=0,r=null!=i&&0!==i?function(){return t()||s>=i}:t,o=function(){return r()?e():(s++,setTimeout(o,n))},setTimeout(o,n)},l=function(t){return null!=t?t.substr(t.indexOf("\n")+1):""},i=function(){function e(t,e,i){this.widget=t,this.n=e,this.parent=i}return e.prototype.$=function(e){return t(e,this.parent)},e.prototype.value=function(){return this.widget.options.values[this.n]},e.prototype.initMap=function(){var e,i,n,s,r,o,a,l,u;return r=this.fields.map,i=this.value(),n={title:"Coverage",name:"Coverage",id:this.widget.element.attr("id"),geo:null!=(o=null!=i?i.geo:void 0)?o:""},s={mode:this.widget.options.mode,json:n,markup:{id_prefix:this.id_prefix}},s.zoom=null!=(a=null!=i?i.zoom:void 0)?a:null,s.center=null!=(l=null!=i?i.center:void 0)?l:null,s.base_layer=null!=(u=null!=i?i.base_layer:void 0)?u:null,e=t.extend(!0,{},this.widget.options.map_options,s),this.nlfeatures=r.nlfeatures(e).data("nlfeatures"),this.nlfeatures},e}(),s=function(i){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,i),n.prototype.init=function(){return this.build(),this.initMap(),this.populate()},n.prototype.build=function(){var e,i,n,s;return e=t(this.widget.element),n=e.attr("id"),s=t("<div id='"+n+"-map' class='map map-container'></div>"),i=t("<div id='"+n+"-free' class='freetext'></div>"),e.addClass("nlfeatures").append(s).append(i),this.fields={map:t("#"+n+"-map"),free:t("#"+n+"-free")},e},n.prototype.populate=function(){var t,e;return t=this.widget.options.values[0].text,e=l(t),""===e?(this.fields.free.detach(),delete this.fields.free):this.fields.free.html(e)},n.prototype.hideMap=function(){},n}(i),n=function(i){function n(){return n.__super__.constructor.apply(this,arguments)}return e(n,i),n.prototype.init=function(){var t;return t=this.widget.element.attr("id"),this.id_prefix="#Elements-"+t.split("-")[1]+"-"+this.n+"-",this.name_prefix=this._idPrefixToNamePrefix(this.id_prefix),this.build(),this.initMap(),this.captureEditor(),this.populate(),this.wire()},n.prototype._idPrefixToNamePrefix=function(t){var e,i,n,s;return t=o(this.id_prefix),s=function(){var e,i,s,r;for(s=t.split("-"),r=[],e=0,i=s.length;i>e;e++)n=s[e],n.length>0&&r.push(n);return r}(),e=s.shift(),i=function(){var t,e,i;for(i=[],t=0,e=s.length;e>t;t++)n=s[t],i.push("["+n+"]");return i}(),""+e+i.join("")},n.prototype._buildMap=function(e){var i;return i=o(this.id_prefix),t(".input",e).addClass("nlfeatures").addClass("nlfeatures-edit").before('<div class="nlfeatures map-container">\n  <div id="'+i+"map\"></div>\n  <div class='nlfeatures-map-tools'>\n    <div class='nlflash'></div>\n  </div>\n</div>")},n.prototype._buildInputs=function(e){var i;return i=o(this.id_prefix),t(".input textarea",e).attr("id",""+i+"free").attr("name",""+this.name_prefix+"[free]").after('<input type="hidden" id="'+i+'geo" name="'+this.name_prefix+'[geo]" value="" />\n<input type="hidden" id="'+i+'zoom" name="'+this.name_prefix+'[zoom]" value="" />\n<input type="hidden" id="'+i+'center_lon" name="'+this.name_prefix+'[center_lon]" value="" />\n<input type="hidden" id="'+i+'center_lat" name="'+this.name_prefix+'[center_lat]" value="" />\n<input type="hidden" id="'+i+'base_layer" name="'+this.name_prefix+'[base_layer]" value="" />\n<input type="hidden" id="'+i+'text" name="'+this.name_prefix+'[text]" value="" />')},n.prototype._buildUseMap=function(e,i){var n;return n=o(this.id_prefix),t(".use-html",e).after('<label class="use-mapon">'+i+'<input type="hidden" name="'+this.name_prefix+'[mapon]" value="0" />\n  <input type="checkbox" name="'+this.name_prefix+'[mapon]" id="'+n+'mapon" value="1" />\n</label>')},n.prototype._populateFields=function(e){return this.fields={map_container:e.find(".map-container"),map:t(""+this.id_prefix+"map"),map_tools:e.find(".nlfeatures-map-tools"),mapon:t(""+this.id_prefix+"mapon"),text:t(""+this.id_prefix+"text"),free:t(""+this.id_prefix+"free"),html:t(""+this.id_prefix+"html"),geo:t(""+this.id_prefix+"geo"),zoom:t(""+this.id_prefix+"zoom"),center_lon:t(""+this.id_prefix+"center_lon"),center_lat:t(""+this.id_prefix+"center_lat"),base_layer:t(""+this.id_prefix+"base_layer"),flash:e.find(".nlflash")}},n.prototype.build=function(){var e,i,n,s,r;return e=t(this.widget.element),n=t(this.parent),s=this.widget.options.labels.html,r=this.widget.options.labels.map,i=o(this.id_prefix),null==n.attr("id")&&n.attr("id",i+"widget"),e.addClass("nlfeatures-on"),this._buildMap(n),this._buildInputs(n),this._buildUseMap(n,r),this._populateFields(n),n},n.prototype.captureEditor=function(){var t=this;return this.fields.mapon.change(function(){return t._onUseMap()}),this.fields.html.change(function(){return t._updateTinyEvents()})},n.prototype.populate=function(t){return null==t&&(t=this.widget.options.values[this.n]),null!=t?(this.fields.html.prop("checked",+t.is_html),this.fields.mapon.prop("checked",+t.is_map),this.fields.geo.val(u(t.geo)),this.fields.zoom.val(u(t.zoom)),null!=t.center&&(this.fields.center_lon.val(u(t.center.lon)),this.fields.center_lat.val(u(t.center.lat))),this.fields.base_layer.val(u(t.base_layer)),this.fields.text.val(u(t.text)),this.fields.free.val(l(t.text))):void 0},n.prototype.wire=function(){var t,e=this;return t=function(){return e.updateFields(e.fields.free.val())},this.fields.free.change(t),this.nlfeatures.element.bind("featureadded.nlfeatures",t).bind("update.nlfeatures",t).bind("delete.nlfeatures",t).bind("refresh.nlfeatures",t).bind("saveview.nlfeatures",function(){return e.nlfeatures.saveViewport(),e.updateFields(),e.flash("View Saved...")}),this.nlfeatures.map.events.on({changebaselayer:t})},n.prototype.usesHtml=function(){return this.fields.html.prop("checked")},n.prototype.usesMap=function(){return this.fields.mapon.prop("checked")},n.prototype.showMap=function(){var t,e=this;return t=this.fields.map.children("button"),t.hide("normal",function(){return e.fields.map_container.slideDown("normal",function(){return t.fadeIn()})})},n.prototype.hideMap=function(){var t,e=this;return t=this.fields.map.children("button"),t.fadeOut("normal",function(){return e.fields.map_container.slideUp()})},n.prototype._onUseMap=function(){return this.usesMap()?this.showMap():this.hideMap(),this.updateFields()},n.prototype._updateTinyEvents=function(){var t,e=this;return this.usesHtml()?(t=this.fields.free.attr("id"),a(function(){return null!=tinymce.get(t)},function(){return e.fields.free.unbind("change"),tinymce.get(t).onChange.add(function(){return e.updateFields()})})):this.fields.free.change(function(){return e.updateFields()})},n.prototype.updateFields=function(){var t,e,i,n,s;return i=this.nlfeatures.getKml(),this.fields.geo.val(i),s=this.nlfeatures.getSavedZoom(),null!=s&&this.fields.zoom.val(s),e=this.nlfeatures.getSavedCenter(),null!=e&&(this.fields.center_lon.val(e.lon),this.fields.center_lat.val(e.lat)),t=this.nlfeatures.getBaseLayerCode(),null!=t&&this.fields.base_layer.val(t),n=this.usesHtml()?tinymce.get(this.fields.free.attr("id")).getContent():this.fields.free.val(),this.fields.text.val(""+i+"|"+s+"|"+(null!=e?e.lon:void 0)+"|"+(null!=e?e.lat:void 0)+"|"+t+"\n"+n)},n.prototype.flash=function(t,e){var i=this;return null==e&&(e=5e3),this.fields.flash.html(t).fadeIn("slow",function(){return setTimeout(function(){return i.fields.flash.fadeOut("slow")},e)})},n}(i),r=function(){function e(e,i,n,s){var r,o;this.widget=e,this.parent=i,this.selector=n,this.nodes=t(this.selector,this.parent),this.widgets=function(){var t,e,i,n;for(i=this.nodes,n=[],r=t=0,e=i.length;e>t;r=++t)o=i[r],n.push(s(o,r));return n}.call(this)}return e.prototype.init=function(t){var e,i,n,s,r,o,a,l,u,d,h;for(a=this.widgets,n=0,r=a.length;r>n;n++)i=a[n],i.init();for(l=this.widgets,h=[],e=s=0,o=l.length;o>s;e=++s)i=l[e],(null!=(u=t.values)?null!=(d=u[e])?d.is_map:void 0:void 0)?h.push(void 0):h.push(i.hideMap());return h},e}(),t.widget("nlfeatures.featurewidget",{options:{mode:"view",labels:{html:"Use HTML",map:"Use Map"},map_options:{},values:{geo:null,zoom:null,center:null,text:null,is_html:null,is_map:null}},_create:function(){var e,i=this;return e=this.element.attr("id"),this.mode="edit"===this.options.mode?new r(this,this.element,".input-block",function(t,e){return new n(i,e,t)}):new r(this,t("#dublin-core-coverage"),"#"+this.element.attr("id"),function(t,e){return new s(i,e,t)}),this.mode.init(this.options)},destroy:function(){return t.Widget.prototype.destroy.call(this)},_setOptions:function(){return t.Widget.prototype._setOption.apply(this,arguments)}})})(jQuery)}.call(this);